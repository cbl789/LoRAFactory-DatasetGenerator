<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRAFactory - Multi-Provider Dataset Generator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">ğŸ­</span>
                <h1>LoRAFactory - Dataset Generator</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-icon" onclick="showSecuritySettings()" title="Security Settings">ğŸ›¡ï¸</button>
                <button class="btn btn-icon" onclick="showApiKeyModal()" title="API Key Settings">ğŸ”‘</button>
                <div class="status-bar">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Checking...</span>
                </div>
            </div>
        </header>

        <!-- Security Warning Banner -->
        <div id="securityBanner" class="security-banner" style="display: none;">
            <div class="banner-content">
                <span class="banner-icon">âš ï¸</span>
                <div class="banner-text">
                    <strong>Security Notice:</strong> Your API key is stored in your browser.
                    For better security, click the ğŸ›¡ï¸ button to enable encryption and session-only storage.
                    <a href="#" onclick="showSecuritySettings(); return false;">Configure Security â†’</a>
                </div>
            </div>
            <button class="banner-close" onclick="dismissSecurityBanner()" title="Dismiss">âœ•</button>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Dataset Panel -->
                <div class="panel">
                    <h2>ğŸ“ Dataset</h2>
                    <div class="dataset-count">
                        <div class="count" id="pairCount">0</div>
                        <small id="countLabel">pairs in memory</small>
                    </div>
                    <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-primary" onclick="downloadZIP()">ğŸ“¥ Download ZIP</button>
                        <button class="btn btn-secondary" onclick="clearResults()">ğŸ—‘ï¸ Clear All</button>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="panel">
                    <h2>âš™ï¸ Settings</h2>

                    <div class="form-group">
                        <label>Aspect Ratio</label>
                        <select id="aspectRatio">
                            <option value="1:1">1:1 (Square)</option>
                            <option value="16:9">16:9 (Landscape)</option>
                            <option value="9:16">9:16 (Portrait)</option>
                            <option value="4:3">4:3</option>
                            <option value="3:4">3:4</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Resolution</label>
                        <select id="resolution">
                            <option value="1K">1K ($0.15/img)</option>
                            <option value="2K">2K ($0.15/img)</option>
                            <option value="4K">4K ($0.30/img)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Image Generation Model</label>
                        <select id="imageModel">
                            <!-- Populated dynamically on load -->
                        </select>
                        <small id="imageModelDesc">Loading models and live pricing from FAL.ai...</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useVisionCaption" checked>
                            <span>Vision Captions</span>
                        </label>
                        <small>Use AI to describe the generated images</small>
                    </div>

                    <div class="form-group">
                        <label>LLM/Vision Model</label>
                        <select id="llmModel">
                            <option value="google/gemini-2.5-flash">Gemini 2.5 Flash - $0.075/$0.30 per 1M tokens
                            </option>
                            <option value="google/gemini-2.5-pro">Gemini 2.5 Pro - $1.25/$5.00 per 1M tokens</option>
                            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet - $3.00/$15.00 per 1M tokens
                            </option>
                            <option value="openai/gpt-4o">GPT-4o - $2.50/$10.00 per 1M tokens</option>
                        </select>
                        <small>Used for prompt generation and vision captions. Prices: input/output per 1M tokens (as of
                            Dec 2024, via OpenRouter). Note: Some models may have compatibility issues with vision - try
                            GPT-4o if errors occur.</small>
                    </div>
                </div>
            </aside>

            <!-- Main Area -->
            <section class="workspace">
                <!-- Generation Panel -->
                <div class="panel">
                    <h2>ğŸ¨ Generate Dataset</h2>

                    <div class="auto-intro">
                        <p>ğŸš€ <strong>Static version</strong>: Runs entirely in your browser! Just describe what you
                            want, AI generates everything.</p>
                    </div>

                    <!-- Mode Selector -->
                    <div class="form-group">
                        <label>ğŸ¯ Generation Mode</label>
                        <div class="mode-selector">
                            <button type="button" class="mode-btn active" data-mode="pair" onclick="setMode('pair')">
                                <span class="mode-icon">ğŸ”„</span>
                                <span class="mode-label">Pair Mode</span>
                                <span class="mode-desc">START â†’ END transformation</span>
                            </button>
                            <button type="button" class="mode-btn" data-mode="single" onclick="setMode('single')">
                                <span class="mode-icon">ğŸ–¼ï¸</span>
                                <span class="mode-label">Single Image</span>
                                <span class="mode-desc">Style/Aesthetic LoRA</span>
                            </button>
                            <button type="button" class="mode-btn" data-mode="reference" onclick="setMode('reference')">
                                <span class="mode-icon">ğŸ“·</span>
                                <span class="mode-label">Reference Image</span>
                                <span class="mode-desc">Variations from uploaded image</span>
                            </button>
                        </div>
                    </div>

                    <!-- Reference Image Upload (hidden by default) -->
                    <div id="referenceUploadSection" class="form-group hidden">
                        <label>ğŸ“· Reference Image</label>
                        <div class="reference-upload">
                            <div class="upload-zone" id="uploadZone"
                                onclick="document.getElementById('referenceInput').click()">
                                <input type="file" id="referenceInput" accept="image/*" style="display:none"
                                    onchange="handleReferenceUpload(event)">
                                <div class="upload-placeholder" id="uploadPlaceholder">
                                    <span class="upload-icon">ğŸ“¤</span>
                                    <span>Click to upload or drag & drop</span>
                                    <small>Character, product, or style reference</small>
                                </div>
                                <img id="referencePreview" class="reference-preview hidden" alt="Reference">
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearReference()"
                                id="clearRefBtn" style="display:none">âœ• Clear</button>
                        </div>
                        <small>Upload an image to create variations based on it</small>
                    </div>

                    <div class="form-group">
                        <label>ğŸ¯ Dataset Theme</label>
                        <input type="text" id="theme"
                            placeholder="Ex: portraits of diverse people, landscape photography, cute animals...">
                    </div>

                    <!-- Transformation (only for pair mode) -->
                    <div id="transformationSection" class="form-group">
                        <label>ğŸ”„ Transformation to Learn</label>
                        <textarea id="transformation" rows="2"
                            placeholder="Ex: progressively zoom out from close-up to full body shot, keeping the subject centered"></textarea>
                    </div>

                    <!-- Action Name (only for pair mode) -->
                    <div id="actionNameSection" class="form-group">
                        <label>ğŸ·ï¸ Action Name <small style="opacity: 0.6">(optional - AI will generate)</small></label>
                        <input type="text" id="actionName"
                            placeholder="Leave empty for AI to generate, or: unzoom, zoom_out...">
                    </div>

                    <div class="form-group">
                        <label>âœ¨ Trigger Word <small style="opacity: 0.6">(optional - prepended to .txt
                                files)</small></label>
                        <input type="text" id="triggerWord" placeholder="e.g., MYZOOM, MYSTYLE...">
                    </div>

                    <!-- Custom System Prompt -->
                    <div class="form-group">
                        <label>ğŸ§  Custom System Prompt</label>
                        <div id="systemPromptSection" class="collapsible-content">
                            <textarea id="customSystemPrompt" rows="4"
                                placeholder="Customize the AI prompt generation behavior..."></textarea>
                            <small>Leave empty for default. This controls how the AI generates creative prompts for your
                                dataset.</small>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="resetSystemPrompt()"
                                style="margin-top: 8px;">â†» Reset to Default</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>ğŸ“Š Number of <span id="pairOrImageLabel">Pairs</span> (max 40)</label>
                        <input type="number" id="numPairs" value="10" min="1" max="40">
                        <small>Estimated cost: <span id="costEstimate">~$3.00</span></small>
                    </div>

                    <div class="form-group">
                        <label>âš¡ Parallel Requests</label>
                        <input type="number" id="maxConcurrent" value="3" min="1" max="10">
                        <small>Higher = faster but uses more concurrent API calls</small>
                    </div>

                    <div class="auto-actions">
                        <button class="btn btn-generate" onclick="startGeneration()">
                            ğŸš€ Start Generation
                        </button>
                        <button class="btn btn-secondary" onclick="stopGeneration()">
                            â¹ï¸ Stop
                        </button>
                    </div>
                </div>

                <!-- Progress Panel -->
                <div id="progressPanel" class="panel progress-panel hidden">
                    <h2>â³ Generation Progress</h2>
                    <div class="progress-info">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> <span
                                id="progressLabel">pairs</span>
                        </div>
                        <div class="progress-status" id="progressStatus">Initializing...</div>
                    </div>
                    <div id="progressLog" class="progress-log"></div>
                </div>

                <!-- Results Panel -->
                <div class="panel results-panel">
                    <h2>ğŸ–¼ï¸ Results</h2>

                    <div id="loadingIndicator" class="loading hidden">
                        <div class="spinner"></div>
                        <span>Generating...</span>
                    </div>

                    <div id="results" class="results-grid"></div>
                </div>
            </section>
        </main>

        <!-- API Key Modal -->
        <div id="apiKeyModal" class="modal hidden">
            <div class="modal-content">
                <h2>ğŸ”‘ API Key Settings</h2>
                <p class="modal-desc">Enter your FAL API key. Get one free at <a href="https://fal.ai/dashboard/keys"
                        target="_blank">fal.ai/dashboard/keys</a></p>

                <!-- Security Warnings -->
                <div class="security-notice">
                    <div class="notice-item">âš ï¸ <strong>Security:</strong> Keys are stored in your browser</div>
                    <div class="notice-item">ğŸ›¡ï¸ Enable encryption in Security Settings (ğŸ›¡ï¸ button) for better
                        protection</div>
                    <div class="notice-item">ğŸš« Never share your API key or use on untrusted devices</div>
                </div>

                <div class="form-group">
                    <label>Provider</label>
                    <select id="providerSelect"
                        style="width: 100%; padding: 8px; margin-bottom: 12px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-color);">
                        <option value="fal">FAL.ai</option>
                        <!-- Other providers will be added here -->
                    </select>
                </div>

                <div class="form-group">
                    <label id="apiKeyLabel">FAL API Key</label>
                    <div class="api-key-input">
                        <input type="password" id="apiKeyInput" placeholder="Enter your API key...">
                        <button class="btn btn-icon" onclick="toggleKeyVisibility()" title="Show/Hide">
                            <span id="keyVisibilityIcon">ğŸ‘ï¸</span>
                        </button>
                    </div>
                    <small>Stored only in your browser. Never sent anywhere except the provider.</small>
                </div>

                <!-- Encryption Password Field (shown when encryption is enabled) -->
                <div id="encryptionPasswordSection" class="form-group hidden">
                    <label>ğŸ” Encryption Password</label>
                    <input type="password" id="encryptionPassword"
                        placeholder="Enter password to encrypt your API key (min 8 characters)">
                    <small>This password encrypts your API key. You'll need it each session.</small>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideApiKeyModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="clearApiKey()">Clear Key</button>
                    <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
                </div>
            </div>
        </div>

        <!-- Security Settings Modal -->
        <div id="securitySettingsModal" class="modal hidden">
            <div class="modal-content">
                <h2>ğŸ›¡ï¸ Security Settings</h2>
                <p class="modal-desc">Configure how your API key is stored and protected</p>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useEncryption">
                        <span>ğŸ” <strong>Encrypt API Key</strong></span>
                    </label>
                    <small>Encrypts your API key with a password using AES-256-GCM. You'll need to enter the password
                        each time you open the app.</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useSessionStorage">
                        <span>â±ï¸ <strong>Session-Only Storage</strong></span>
                    </label>
                    <small>API key cleared when you close the browser tab. More secure for shared computers.</small>
                </div>

                <div class="form-group">
                    <label>â° Auto-Clear After Inactivity (minutes)</label>
                    <input type="number" id="autoClockMinutes" min="0" max="120" placeholder="0 = disabled">
                    <small>Automatically clear API key after specified minutes of inactivity. 0 = disabled.</small>
                </div>

                <div class="security-recommendations">
                    <h3>ğŸ“‹ Security Best Practices:</h3>
                    <ul>
                        <li>âœ… Use encryption if storing key persistently</li>
                        <li>âœ… Use session-only storage on shared computers</li>
                        <li>âœ… Enable auto-clear (15-30 min) for added security</li>
                        <li>âœ… Always use HTTPS when accessing this app</li>
                        <li>âœ… Clear browser data after use on public computers</li>
                        <li>ğŸš« Never install untrusted browser extensions</li>
                        <li>ğŸš« Never use on untrusted networks without VPN</li>
                    </ul>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideSecuritySettings()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>


    <footer class="app-footer" style="text-align: center; padding: 20px; opacity: 0.6; font-size: 0.9em;">
        <p>Original by <a href="https://lovis.io" target="_blank"
                style="color: inherit; text-decoration: underline;">Lovis.io</a> | Enhanced Version</p>
    </footer>

    <script type="module" src="app.js"></script>
</body>

</html>