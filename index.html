<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LoRAFactory - Multi-Provider Dataset Generator</title>
    <link rel="stylesheet" href="style.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
</head>

<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <span class="logo-icon">üè≠</span>
                <h1>LoRAFactory - Dataset Generator</h1>
            </div>
            <div class="header-actions">
                <button class="btn btn-icon" onclick="showSecuritySettings()" title="Security Settings">üõ°Ô∏è</button>
                <button class="btn btn-icon" onclick="showApiKeyModal()" title="API Key Settings">üîë</button>
                <div class="status-bar">
                    <span class="status-dot" id="statusDot"></span>
                    <span id="statusText">Checking...</span>
                </div>
            </div>
        </header>

        <!-- Security Warning Banner -->
        <div id="securityBanner" class="security-banner" style="display: none;">
            <div class="banner-content">
                <span class="banner-icon">‚ö†Ô∏è</span>
                <div class="banner-text">
                    <strong>Security Notice:</strong> Your API key is stored in your browser.
                    For better security, click the üõ°Ô∏è button to enable encryption and session-only storage.
                    <a href="#" onclick="showSecuritySettings(); return false;">Configure Security ‚Üí</a>
                </div>
            </div>
            <button class="banner-close" onclick="dismissSecurityBanner()" title="Dismiss">‚úï</button>
        </div>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Dataset Panel -->
                <div class="panel">
                    <h2>üìÅ Dataset</h2>
                    <div class="dataset-count">
                        <div class="count" id="pairCount">0</div>
                        <small id="countLabel">pairs in memory</small>
                    </div>
                    <div style="margin-top: 16px; display: flex; flex-direction: column; gap: 8px;">
                        <button class="btn btn-primary" onclick="downloadZIP()">üì• Download ZIP</button>
                        <button class="btn btn-secondary" onclick="clearResults()">üóëÔ∏è Clear All</button>
                    </div>
                </div>

                <!-- Settings Panel -->
                <div class="panel">
                    <h2>‚öôÔ∏è Settings</h2>

                    <div class="form-group">
                        <label>Aspect Ratio</label>
                        <select id="aspectRatio">
                            <option value="1:1">1:1 (Square)</option>
                            <option value="16:9">16:9 (Landscape)</option>
                            <option value="9:16">9:16 (Portrait)</option>
                            <option value="4:3">4:3</option>
                            <option value="3:4">3:4</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Resolution</label>
                        <select id="resolution">
                            <option value="1K">1K ($0.15/img)</option>
                            <option value="2K">2K ($0.15/img)</option>
                            <option value="4K">4K ($0.30/img)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Image Generation Model</label>
                        <select id="imageModel">
                            <!-- Populated dynamically on load -->
                        </select>
                        <small id="imageModelDesc">Loading models and live pricing from FAL.ai...</small>
                    </div>

                    <div class="form-group">
                        <label class="checkbox-label">
                            <input type="checkbox" id="useVisionCaption" checked>
                            <span>Vision Captions</span>
                        </label>
                        <small>Use AI to describe the generated images</small>
                    </div>

                    <div class="form-group">
                        <label>LLM/Vision Model</label>
                        <select id="llmModel">
                            <option value="google/gemini-2.5-flash">Gemini 2.5 Flash - $0.075/$0.30 per 1M tokens
                            </option>
                            <option value="google/gemini-2.5-pro">Gemini 2.5 Pro - $1.25/$5.00 per 1M tokens</option>
                            <option value="anthropic/claude-3.5-sonnet">Claude 3.5 Sonnet - $3.00/$15.00 per 1M tokens
                            </option>
                            <option value="openai/gpt-4o">GPT-4o - $2.50/$10.00 per 1M tokens</option>
                        </select>
                        <small>Used for prompt generation and vision captions. Prices: input/output per 1M tokens (as of
                            Dec 2024, via OpenRouter). Note: Some models may have compatibility issues with vision - try
                            GPT-4o if errors occur.</small>
                    </div>
                </div>
            </aside>

            <!-- Main Area -->
            <section class="workspace">
                <!-- Generation Panel -->
                <div class="panel">
                    <h2>üé® Generate Dataset</h2>

                    <div class="auto-intro">
                        <p>üöÄ <strong>Static version</strong>: Runs entirely in your browser! Just describe what you
                            want, AI generates everything.</p>
                    </div>

                    <!-- Mode Selector -->
                    <div class="form-group">
                        <label>üéØ Generation Mode</label>
                        <div class="mode-selector">
                            <button type="button" class="mode-btn active" data-mode="pair" onclick="setMode('pair')">
                                <span class="mode-icon">üîÑ</span>
                                <span class="mode-label">Pair Mode</span>
                                <span class="mode-desc">START ‚Üí END transformation</span>
                            </button>
                            <button type="button" class="mode-btn" data-mode="single" onclick="setMode('single')">
                                <span class="mode-icon">üñºÔ∏è</span>
                                <span class="mode-label">Single Image</span>
                                <span class="mode-desc">Style/Aesthetic LoRA</span>
                            </button>
                            <button type="button" class="mode-btn" data-mode="reference" onclick="setMode('reference')">
                                <span class="mode-icon">üì∑</span>
                                <span class="mode-label">Reference Image</span>
                                <span class="mode-desc">Variations from uploaded image</span>
                            </button>
                        </div>
                    </div>

                    <!-- Reference Image Upload (hidden by default) -->
                    <div id="referenceUploadSection" class="form-group hidden">
                        <label>üì∑ Reference Image</label>
                        <div class="reference-upload">
                            <div class="upload-zone" id="uploadZone"
                                onclick="document.getElementById('referenceInput').click()">
                                <input type="file" id="referenceInput" accept="image/*" style="display:none"
                                    onchange="handleReferenceUpload(event)">
                                <div class="upload-placeholder" id="uploadPlaceholder">
                                    <span class="upload-icon">üì§</span>
                                    <span>Click to upload or drag & drop</span>
                                    <small>Character, product, or style reference</small>
                                </div>
                                <img id="referencePreview" class="reference-preview hidden" alt="Reference">
                            </div>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="clearReference()"
                                id="clearRefBtn" style="display:none">‚úï Clear</button>
                        </div>
                        <small>Upload an image to create variations based on it</small>
                    </div>

                    <div class="form-group">
                        <label>üéØ Dataset Theme</label>
                        <input type="text" id="theme"
                            placeholder="Ex: portraits of diverse people, landscape photography, cute animals...">
                    </div>

                    <!-- Transformation (only for pair mode) -->
                    <div id="transformationSection" class="form-group">
                        <label>üîÑ Transformation to Learn</label>
                        <textarea id="transformation" rows="2"
                            placeholder="Ex: progressively zoom out from close-up to full body shot, keeping the subject centered"></textarea>
                    </div>

                    <!-- Action Name (only for pair mode) -->
                    <div id="actionNameSection" class="form-group">
                        <label>üè∑Ô∏è Action Name <small style="opacity: 0.6">(optional - AI will generate)</small></label>
                        <input type="text" id="actionName"
                            placeholder="Leave empty for AI to generate, or: unzoom, zoom_out...">
                    </div>

                    <div class="form-group">
                        <label>‚ú® Trigger Word <small style="opacity: 0.6">(optional - prepended to .txt
                                files)</small></label>
                        <input type="text" id="triggerWord" placeholder="e.g., MYZOOM, MYSTYLE...">
                    </div>

                    <!-- Custom System Prompt -->
                    <div class="form-group">
                        <label>üß† Custom System Prompt</label>
                        <div id="systemPromptSection" class="collapsible-content">
                            <textarea id="customSystemPrompt" rows="4"
                                placeholder="Customize the AI prompt generation behavior..."></textarea>
                            <small>Leave empty for default. This controls how the AI generates creative prompts for your
                                dataset.</small>
                            <button type="button" class="btn btn-secondary btn-sm" onclick="resetSystemPrompt()"
                                style="margin-top: 8px;">‚Üª Reset to Default</button>
                        </div>
                    </div>

                    <div class="form-group">
                        <label>üìä Number of <span id="pairOrImageLabel">Pairs</span> (max 40)</label>
                        <input type="number" id="numPairs" value="20" min="1" max="40">
                        <small>Estimated cost: <span id="costEstimate">~$3.00</span></small>
                    </div>

                    <div class="form-group">
                        <label>‚ö° Parallel Requests</label>
                        <input type="number" id="maxConcurrent" value="3" min="1" max="10">
                        <small>Higher = faster but uses more concurrent API calls</small>
                    </div>

                    <div class="auto-actions">
                        <button class="btn btn-generate" onclick="startGeneration()">
                            üöÄ Start Generation
                        </button>
                        <button class="btn btn-secondary" onclick="stopGeneration()">
                            ‚èπÔ∏è Stop
                        </button>
                    </div>
                </div>

                <!-- Progress Panel -->
                <div id="progressPanel" class="panel progress-panel hidden">
                    <h2>‚è≥ Generation Progress</h2>
                    <div class="progress-info">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progressFill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progressCurrent">0</span> / <span id="progressTotal">0</span> <span
                                id="progressLabel">pairs</span>
                        </div>
                        <div class="progress-status" id="progressStatus">Initializing...</div>
                    </div>
                    <div id="progressLog" class="progress-log"></div>
                </div>

                <!-- Results Panel -->
                <div class="panel results-panel">
                    <h2>üñºÔ∏è Results</h2>

                    <div id="loadingIndicator" class="loading hidden">
                        <div class="spinner"></div>
                        <span>Generating...</span>
                    </div>

                    <div id="results" class="results-grid"></div>
                </div>
            </section>
        </main>

        <!-- API Key Modal -->
        <div id="apiKeyModal" class="modal hidden">
            <div class="modal-content">
                <h2>üîë API Key Settings</h2>
                <p class="modal-desc">Enter your FAL API key. Get one free at <a href="https://fal.ai/dashboard/keys"
                        target="_blank">fal.ai/dashboard/keys</a></p>

                <!-- Security Warnings -->
                <div class="security-notice">
                    <div class="notice-item">‚ö†Ô∏è <strong>Security:</strong> Keys are stored in your browser</div>
                    <div class="notice-item">üõ°Ô∏è Enable encryption in Security Settings (üõ°Ô∏è button) for better
                        protection</div>
                    <div class="notice-item">üö´ Never share your API key or use on untrusted devices</div>
                </div>

                <div class="form-group">
                    <label>Provider</label>
                    <div style="display: flex; gap: 8px;">
                        <select id="providerSelect"
                            style="flex-grow: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-input); color: var(--text-color);">
                            <option value="fal">FAL.ai</option>
                        </select>
                        <button class="btn btn-secondary" onclick="showAddProviderModal()" title="Add Custom Provider">
                            ‚ûï
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label id="apiKeyLabel">FAL API Key</label>
                    <div class="api-key-input">
                        <input type="password" id="apiKeyInput" placeholder="Enter your API key...">
                        <button class="btn btn-icon" onclick="toggleKeyVisibility()" title="Show/Hide">
                            <span id="keyVisibilityIcon">üëÅÔ∏è</span>
                        </button>
                    </div>
                    <small>Stored only in your browser. Never sent anywhere except the provider.</small>
                </div>

                <!-- Encryption Password Field (shown when encryption is enabled) -->
                <div id="encryptionPasswordSection" class="form-group hidden">
                    <label>üîê Encryption Password</label>
                    <input type="password" id="encryptionPassword"
                        placeholder="Enter password to encrypt your API key (min 8 characters)">
                    <small>This password encrypts your API key. You'll need it each session.</small>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideApiKeyModal()">Cancel</button>
                    <button class="btn btn-danger" onclick="clearApiKey()">Clear Key</button>
                    <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
                </div>
            </div>
        </div>

        <!-- Add Custom Provider Modal -->
        <div id="addProviderModal" class="modal hidden">
            <div class="modal-content" style="max-width: 600px;">
                <h2>üîå Add Custom Provider</h2>
                <p class="modal-desc">Configure a REST API endpoint for image generation.</p>

                <div class="form-group">
                    <label>Provider Name</label>
                    <input type="text" id="custProvName" placeholder="e.g. Local SD, OpenAI DALL-E">
                </div>

                <div class="form-group">
                    <label>Unique ID</label>
                    <input type="text" id="custProvId" placeholder="e.g. local-sd"
                        oninput="this.value = this.value.toLowerCase().replace(/[^a-z0-9-]/g, '')">
                </div>

                <div class="form-group">
                    <label>API Endpoint (POST)</label>
                    <input type="text" id="custProvUrl" placeholder="https://api.example.com/v1/generate">
                </div>

                <div style="display: flex; gap: 12px;">
                    <div class="form-group" style="flex: 1;">
                        <label>Auth Header</label>
                        <input type="text" id="custProvAuthHeader" value="Authorization" placeholder="Authorization">
                    </div>
                    <div class="form-group" style="flex: 1;">
                        <label>Auth Prefix</label>
                        <input type="text" id="custProvAuthPrefix" value="Bearer " placeholder="Bearer ">
                    </div>
                </div>

                <div class="form-group">
                    <label>Request Body Template (JSON)</label>
                    <textarea id="custProvBody" rows="5" class="code-font"
                        placeholder='{"prompt": "{{prompt}}", "aspect_ratio": "{{aspectRatio}}", "size": "1024x1024"}'></textarea>
                    <small>Variables: <code>{{prompt}}</code>, <code>{{aspectRatio}}</code>,
                        <code>{{resolution}}</code></small>
                </div>

                <div class="form-group">
                    <label>Response JSON Path to Image URL</label>
                    <input type="text" id="custProvResponsePath" value="images.0.url"
                        placeholder="e.g. data.0.url or output.image">
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary"
                        onclick="document.getElementById('addProviderModal').classList.add('hidden')">Cancel</button>
                    <button class="btn btn-primary" onclick="handleSaveProvider()">Save Provider</button>
                </div>
            </div>
        </div>

        <!-- Helper script for saving provider -->
        <script>
            function showAddProviderModal() {
                document.getElementById('apiKeyModal').classList.add('hidden');
                document.getElementById('addProviderModal').classList.remove('hidden');
            }

            function handleSaveProvider() {
                const config = {
                    id: document.getElementById('custProvId').value,
                    name: document.getElementById('custProvName').value,
                    endpoints: {
                        generateImage: {
                            url: document.getElementById('custProvUrl').value,
                            headers: {},
                            body: document.getElementById('custProvBody').value, // Store as string template
                            responsePath: document.getElementById('custProvResponsePath').value
                        }
                    },
                    auth: {
                        header: document.getElementById('custProvAuthHeader').value,
                        prefix: document.getElementById('custProvAuthPrefix').value
                    }
                };

                if (!config.id || !config.name || !config.endpoints.generateImage.url) {
                    alert('Please fill in Name, ID, and URL');
                    return;
                }

                // Call app.js exported function
                if (window.addCustomProvider) {
                    window.addCustomProvider(config);
                    document.getElementById('addProviderModal').classList.add('hidden');
                    // Re-open API modal to show new provider selected?
                    // For now, confirm and let user reopen
                    alert('Provider added! Select it from the list.');
                    window.showApiKeyModal();
                } else {
                    alert('Error: addCustomProvider function not found');
                }
            }
        </script>

        <!-- Security Settings Modal -->
        <div id="securitySettingsModal" class="modal hidden">
            <div class="modal-content">
                <h2>üõ°Ô∏è Security Settings</h2>
                <p class="modal-desc">Configure how your API key is stored and protected</p>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useEncryption">
                        <span>üîê <strong>Encrypt API Key</strong></span>
                    </label>
                    <small>Encrypts your API key with a password using AES-256-GCM. You'll need to enter the password
                        each time you open the app.</small>
                </div>

                <div class="form-group">
                    <label class="checkbox-label">
                        <input type="checkbox" id="useSessionStorage">
                        <span>‚è±Ô∏è <strong>Session-Only Storage</strong></span>
                    </label>
                    <small>API key cleared when you close the browser tab. More secure for shared computers.</small>
                </div>

                <div class="form-group">
                    <label>‚è∞ Auto-Clear After Inactivity (minutes)</label>
                    <input type="number" id="autoClockMinutes" min="0" max="120" placeholder="0 = disabled">
                    <small>Automatically clear API key after specified minutes of inactivity. 0 = disabled.</small>
                </div>

                <div class="security-recommendations">
                    <h3>üìã Security Best Practices:</h3>
                    <ul>
                        <li>‚úÖ Use encryption if storing key persistently</li>
                        <li>‚úÖ Use session-only storage on shared computers</li>
                        <li>‚úÖ Enable auto-clear (15-30 min) for added security</li>
                        <li>‚úÖ Always use HTTPS when accessing this app</li>
                        <li>‚úÖ Clear browser data after use on public computers</li>
                        <li>üö´ Never install untrusted browser extensions</li>
                        <li>üö´ Never use on untrusted networks without VPN</li>
                    </ul>
                </div>

                <div class="modal-actions">
                    <button class="btn btn-secondary" onclick="hideSecuritySettings()">Cancel</button>
                    <button class="btn btn-primary" onclick="saveSecuritySettings()">Save Settings</button>
                </div>
            </div>
        </div>
    </div>


    <footer class="app-footer" style="text-align: center; padding: 20px; opacity: 0.6; font-size: 0.9em;">
        <p>Original by <a href="https://lovis.io" target="_blank"
                style="color: inherit; text-decoration: underline;">Lovis.io</a> | Enhanced Version</p>
    </footer>

    <!-- Image Preview Modal -->
    <div id="imagePreviewModal" class="modal image-preview-modal hidden" onclick="closeImagePreview()">
        <span class="close-preview">&times;</span>
        <img class="preview-content" id="previewImage" onclick="event.stopPropagation()">
    </div>

    <script type="module" src="app.js"></script>
</body>

</html>